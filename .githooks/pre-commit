#!/usr/bin/env bash
# Pre-commit: tidy Markdown and run markdownlint if available.
set -euo pipefail

echo "[pre-commit] Preparing Markdown changes…"

# 1) Autotidy: trim trailing spaces and ensure newline-at-EOF on staged Markdown files
STAGED_MD=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|mdx)$' || true)

if [ -n "${STAGED_MD}" ]; then
  echo "${STAGED_MD}" | while read -r file; do
    [ -f "$file" ] || continue
    # Trim trailing spaces and ensure EOF newline (in-place, POSIX-friendly)
    # Note: Use perl for cross-platform editing reliability
    perl -0777 -pe 's/[ \t]+(\r?\n)/\1/g; END{ if(substr($_,-1) !~ /\n/) { $_ .= "\n" } }' "$file" > "$file.__tmp__"
    if ! cmp -s "$file" "$file.__tmp__"; then
      mv "$file.__tmp__" "$file"
      git add "$file"
      echo "  • tidied: $file"
    else
      rm -f "$file.__tmp__"
    fi
  done
else
  echo "[pre-commit] No staged Markdown files to tidy."
fi

# 2) Run markdownlint if available (markdownlint-cli2 preferred)
if command -v markdownlint-cli2 >/dev/null 2>&1; then
  echo "[pre-commit] Running markdownlint-cli2…"
  markdownlint-cli2 "**/*.md" || {
    echo "[x] markdownlint issues detected. Fix and re-stage."; exit 1;
  }
elif command -v markdownlint >/dev/null 2>&1; then
  echo "[pre-commit] Running markdownlint…"
  markdownlint "**/*.md" || {
    echo "[x] markdownlint issues detected. Fix and re-stage."; exit 1;
  }
else
  echo "[pre-commit] Skipping lint: markdownlint not installed."
fi

echo "[pre-commit] OK."
exit 0
